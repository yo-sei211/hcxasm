<!DOCTYPE html>
<html>
  <head>
    <!--
    これはHC4, 4e, HC8シリーズ用のビジュアルアセンブラです.
    わかりやすいブロックによってアセンブリ言語を書くことができます.
    -->
    <meta charset="utf-8">
    <title>HCx Series Visual Assembler</title>
    <!-- Blockly本体の読み込み（オンライン版） -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <!-- ビジュアルアセンブラのスタイル -->
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <div style="margin-bottom: 10px; margin-top: 10px; display:flex; gap:12px; align-items:center;">
      <label>Architecture:</label>
      <select id="archSelect">
        <option value="HC4">HC4</option>
        <option value="HC4E">HC4E</option>
      </select>
      <button id="saveButton" onclick="saveAssemblyFile()">アセンブリファイルを保存</button>
    </div>
    <!-- Blocklyエディタを置く場所 -->
    <div id="blocklyContainer">
      <div id="toolboxSidebar">
        <button class="toolbox-cat active" data-anchor="label">ラベル</button>
        <button class="toolbox-cat" data-anchor="command">普通の命令</button>
        <button class="toolbox-cat" data-anchor="macro">マクロ</button>
      </div>
      <div id="blocklyDiv"></div>
    </div>
    <!-- 出力結果表示エリア（タブ構造） -->
    <div id="outputContainer">
      <div class="tab-header">
        <button class="tab-button active" onclick="switchTab('assembly')">アセンブリ</button>
        <button class="tab-button" onclick="switchTab('output')">出力</button>
        <button class="tab-button" onclick="switchTab('register')">レジスタ</button>
      </div>
      <div class="tab-content">
        <div id="assemblyTab" class="tab-pane active">
          <div id="output">生成されたアセンブリコードがここに表示されます...</div>
        </div>
        <div id="outputTab" class="tab-pane">
          <div id="messageOutput">出力メッセージがここに表示されます...</div>
        </div>
        <div id="registerTab" class="tab-pane">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
            <button onclick="fetchRegisters()">更新</button>
            <button id="traceButton" onclick="toggleTrace()">トレース</button>
            <span id="registerStatus" style="color:#666;"></span>
          </div>
          <div id="registerOutput">レジスタの内容がここに表示されます...</div>
        </div>
      </div>
    </div>

    <!-- ラベル入力ダイアログ -->
    <div id="labelDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; min-width: 300px;">
        <h4>新しいラベルを作成</h4>
        <p>新しいラベル名を入力してください:</p>
        <input type="text" id="labelInput" style="width: 100%; padding: 5px; margin: 10px 0;" />
        <div style="text-align: right; margin-top: 15px;">
          <button onclick="cancelLabelCreation()" style="margin-right: 10px;">キャンセル</button>
          <button onclick="confirmLabelCreation()">OK</button>
        </div>
      </div>
    </div>

    <!-- タブ切り替え機能 -->
    <script>
      function switchTab(tabName) {
        // すべてのタブボタンとタブペインから active クラスを削除
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        tabButtons.forEach(button => button.classList.remove('active'));
        tabPanes.forEach(pane => pane.classList.remove('active'));
        
        // 選択されたタブをアクティブにする
        const activeButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
        const activePane = document.getElementById(tabName + 'Tab');
        
        if (activeButton) activeButton.classList.add('active');
        if (activePane) activePane.classList.add('active');
      }

      // アーキテクチャ切替
      document.addEventListener('DOMContentLoaded', function() {
        const sel = document.getElementById('archSelect');
        if (sel) {
          sel.value = (window.architecture || 'HC4');
          sel.addEventListener('change', function() {
            window.architecture = sel.value;
            // 再初期化でツールボックスとジェネレータを更新
            if (typeof initializeApp === 'function') {
              initializeApp();
            }
          });
        }
      });
    </script>

    <!-- ビジュアルアセンブラ本体コード -->
    <script src="js/visual-assembler.js"></script>
    <!-- UI機能 -->
    <script src="js/ui-functions.js"></script>
  </body>
</html>
</html>
